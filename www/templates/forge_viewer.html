<html>
  <head>
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1, user-scalable=no" />
    <meta charset="utf-8">

    <!-- The Viewer JS -->
    <script src="https://developer.api.autodesk.com/modelderivative/v2/viewers/7.*/viewer3D.min.js"></script>

    <!-- The Viewer CSS -->
    <link rel="stylesheet" href="https://developer.api.autodesk.com/modelderivative/v2/viewers/style.min.css" type="text/css">
    <!-- Developer CSS -->
    <style>
        body {
            margin: 0;
        }
        #MyViewerDiv {
            width: 100%;
            height: 100%;
            margin: 0;
            background-color: #F0F8FF;
        }
        .show-env-bg-button {
          background: red;
        }
        .hide-env-bg-button {
          background: blue;
        }
    </style>

    <script>

          function launchViewer(urn) {
              var options = {
                env: 'AutodeskProduction',
                getAccessToken: function(onGetAccessToken) {
                  // get the forge access token from the local test server
                  // NOTE: there is a lack of proper authentication here. You'll
                  // need to consider where and how you might run code like this.
                  // You should never expose access tokens on a non secure
                  // connection or on a non-private network.
                  var expireTimeSeconds = 86400;
                  var local_test_server = "https://desolate-beach-90284.herokuapp.com/token";
                  var request = new XMLHttpRequest();
                  request.open('GET', local_test_server, true);
                  request.send();
                  request.onreadystatechange = function () {
                      if (request.readyState === 4 && request.status === 200) {
                          onGetAccessToken(request.responseText, expireTimeSeconds);
                      }
                  }
                  console.log(request.content)
              }
            };

            Autodesk.Viewing.Initializer(options, () => {
              viewer_options = {
                disabledExtensions: {
                  layermanage:true,
                  explode:true,
                  section:true,
                  bimwalk:true,
                  fusionOrbit:true
                }
              }

              viewer = new Autodesk.Viewing.GuiViewer3D(document.getElementById('forgeViewer'),viewer_options);
              viewer.start();
              var documentId = 'urn:' + urn;
              Autodesk.Viewing.Document.load(documentId, onDocumentLoadSuccess, onDocumentLoadFailure);
            });
          }

          function onDocumentLoadSuccess(doc) {
            var viewables = doc.getRoot().getDefaultGeometry();
            
            if (ids != ""){
              model_options = {
                skipPropertyDb: true,
                ids: ids
              }
              viewer.loadDocumentNode(doc, viewables, model_options).then(i => {
                // documented loaded, any action?
              });
            }
            else{
              viewer.loadDocumentNode(doc, viewables).then(i => {
                // documented loaded, any action?
              });
            }
              
          }

          function onDocumentLoadFailure(viewerErrorCode) {
            console.error('onDocumentLoadFailure() - errorCode:' + viewerErrorCode);
          }
    </script>
  </head>
  <body>
      <!-- The Viewer will be instantiated here -->
      <div id="forgeViewer"></div>
      <script>
          var viewer;
          var urn = "{{ forge_urn }}"
          var ids = "{{ ids }}"
          
          
          if (ids != ""){
            ids = ids.split(",");
          }

          console.log(ids)
          launchViewer (urn)
          
      </script>
   </body>
</html>